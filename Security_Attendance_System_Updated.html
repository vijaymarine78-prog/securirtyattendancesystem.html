<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Attendance System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header h2 {
            font-size: 1.3em;
            font-weight: 300;
            opacity: 0.9;
        }

        .datetime-display {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 1.1em;
        }

        .form-section {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .guard-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .guard-entry h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .photo-section {
            margin-top: 15px;
        }

        .photo-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            overflow: hidden;
            margin: 15px auto;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .photo-preview span {
            color: #999;
            font-size: 0.9em;
        }

        .photo-preview video {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
            margin-right: 10px;
            width: 100%;
            max-width: 300px;
            display: block;
            margin: 10px auto;
        }

        .btn-secondary:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            margin: 10px auto;
            display: block;
            max-width: 300px;
        }

        .btn-info:hover {
            background: #138496;
        }

        .guards-list {
            margin-top: 20px;
        }

        .guard-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .guard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .guard-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .submit-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .summary {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .guard-info {
                grid-template-columns: 1fr;
            }
        }

        #pdfReport {
            background: white;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #1e3c72;
        }

        .report-header h1 {
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .report-header h2 {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .report-table th,
        .report-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .report-table th {
            background: #1e3c72;
            color: white;
        }

        .report-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .add-new-section {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .add-new-section button {
            max-width: 250px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Security Attendance System</h1>
            <h2>RNA Courtyard CHS Ltd.</h2>
            <div class="datetime-display" id="datetime"></div>
        </div>

        <div class="form-section">
            <div id="alertBox" class="hidden"></div>

            <!-- Add New Personnel to Database Section -->
            <div class="add-new-section">
                <h3 style="color: #1e3c72; margin-bottom: 10px;">ðŸ“‹ Database Management</h3>
                <p style="color: #666; margin-bottom: 15px;">Add new security agencies or personnel to the master database</p>
                <button type="button" class="btn btn-info" onclick="showAddToDatabase()">
                    âž• Add New Agency/Personnel
                </button>
            </div>

            <!-- Add to Database Form (Hidden by default) -->
            <div id="addDatabaseForm" class="guard-entry" style="display: none;">
                <h3>Add to Master Database</h3>
                
                <div class="form-group">
                    <label for="dbAgencyName">Security Agency Name *</label>
                    <input type="text" id="dbAgencyName" placeholder="Enter new agency name">
                </div>

                <div class="form-group">
                    <label for="dbPersonnelName">Security Personnel Name *</label>
                    <input type="text" id="dbPersonnelName" placeholder="Enter personnel name">
                </div>

                <div class="form-group">
                    <label for="dbDesignation">Designation *</label>
                    <select id="dbDesignation">
                        <option value="">Select Designation</option>
                        <option value="Security Guard">Security Guard</option>
                        <option value="Security Supervisor">Security Supervisor</option>
                        <option value="Security Officer">Security Officer</option>
                        <option value="Chief Security Officer">Chief Security Officer</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-primary" onclick="addToDatabase()">
                        ðŸ’¾ Save to Database
                    </button>
                    <button type="button" class="btn btn-danger" onclick="cancelAddDatabase()">
                        âœ– Cancel
                    </button>
                </div>
            </div>

            <!-- Main Attendance Form -->
            <div class="form-group">
                <label for="agencyName">Select Security Agency *</label>
                <select id="agencyName" required onchange="loadPersonnelByAgency()">
                    <option value="">Select Agency</option>
                </select>
            </div>

            <div class="form-group">
                <label for="shiftTiming">Shift Timing *</label>
                <select id="shiftTiming" required>
                    <option value="">Select Shift</option>
                    <option value="0800 AM - 0800 PM">0800 AM - 0800 PM</option>
                    <option value="0800 PM - 0800 AM">0800 PM - 0800 AM</option>
                </select>
            </div>

            <div class="guard-entry">
                <h3>Mark Attendance for Security Personnel</h3>
                
                <div class="form-group">
                    <label for="guardName">Select Security Personnel *</label>
                    <select id="guardName" onchange="autoFillDesignation()">
                        <option value="">First select an agency</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="designation">Designation *</label>
                    <input type="text" id="designation" readonly style="background-color: #f0f0f0;">
                </div>

                <div class="form-group">
                    <label for="postLocation">Posted Location *</label>
                    <select id="postLocation">
                        <option value="">Select Location</option>
                        <option value="Main Gate">Main Gate</option>
                        <option value="Back Gate">Back Gate</option>
                        <option value="Parking Area">Parking Area</option>
                        <option value="Lobby">Lobby</option>
                        <option value="Roving">Roving</option>
                        <option value="CCTV Room">CCTV Room</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Capture Photo (Camera Only) *</label>
                    <div class="photo-section">
                        <div class="photo-preview" id="photoPreview">
                            <span>Click "Open Camera" to capture photo</span>
                        </div>
                        <div class="camera-controls">
                            <button type="button" class="btn btn-secondary" onclick="openCamera()">
                                ðŸ“· Open Camera
                            </button>
                            <button type="button" class="btn btn-danger" onclick="closeCamera()" id="closeCameraBtn" style="display: none;">
                                âœ– Close Camera
                            </button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="addGuard()">
                    âœ… Mark Attendance
                </button>
            </div>

            <div class="guards-list" id="guardsList"></div>

            <div class="submit-section">
                <div class="summary" id="summary">
                    <h3>Attendance Summary</h3>
                    <div class="summary-item">
                        <span>Total Security Personnel:</span>
                        <strong id="totalGuards">0</strong>
                    </div>
                    <div class="summary-item">
                        <span>Date:</span>
                        <strong id="summaryDate"></strong>
                    </div>
                    <div class="summary-item">
                        <span>Shift:</span>
                        <strong id="summaryShift">Not selected</strong>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitAttendance()" style="font-size: 1.1em; padding: 15px;">
                    ðŸ“Š Submit Attendance & Generate Report
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden PDF Report Template -->
    <div id="pdfReport" style="display:none;">
        <div class="report-header">
            <h1>Security Attendance Report</h1>
            <h2>RNA Courtyard CHS Ltd.</h2>
            <p id="reportDateTime"></p>
            <p id="reportAgency"></p>
            <p id="reportShift"></p>
        </div>
        <table class="report-table" id="reportTable">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Name</th>
                    <th>Designation</th>
                    <th>Location</th>
                    <th>Check-in Time</th>
                </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
        </table>
        <div style="margin-top: 30px;">
            <p><strong>Total Personnel Present: <span id="reportTotal"></span></strong></p>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION - GOOGLE SHEETS INTEGRATION
        // ==========================================
        
        // REPLACE WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbx2z_jXqyL-6s0Xz_L2GaxswBA_TF2wk4S_NvhSRG-xMUQKmQVz4NtMEraO106LRGHwFQ/exec';
        
        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        
        let guards = [];
        let currentPhotoData = null;
        let videoStream = null;
        let personnelDatabase = [];
        let agencyDatabase = [];

        // ==========================================
        // DATE AND TIME MANAGEMENT
        // ==========================================
        
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-IN', options);
            document.getElementById('summaryDate').textContent = now.toLocaleDateString('en-IN');
        }

        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Update shift summary
        document.getElementById('shiftTiming').addEventListener('change', function() {
            document.getElementById('summaryShift').textContent = this.value || 'Not selected';
        });

        // ==========================================
        // CAMERA FUNCTIONALITY
        // ==========================================
        
        async function openCamera() {
            try {
                // Request camera access with rear camera preference
                const constraints = {
                    video: {
                        facingMode: { ideal: "environment" }, // Prefer rear camera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoElement = document.createElement('video');
                videoElement.setAttribute('playsinline', '');
                videoElement.setAttribute('autoplay', '');
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.style.objectFit = 'cover';
                
                const photoPreview = document.getElementById('photoPreview');
                photoPreview.innerHTML = '';
                photoPreview.appendChild(videoElement);
                
                videoElement.srcObject = videoStream;
                
                // Add capture button
                const captureBtn = document.createElement('button');
                captureBtn.type = 'button';
                captureBtn.className = 'btn btn-secondary';
                captureBtn.textContent = 'ðŸ“¸ Capture Photo';
                captureBtn.onclick = capturePhotoFromCamera;
                captureBtn.style.position = 'absolute';
                captureBtn.style.bottom = '10px';
                captureBtn.style.left = '50%';
                captureBtn.style.transform = 'translateX(-50%)';
                captureBtn.style.width = 'auto';
                
                photoPreview.style.position = 'relative';
                photoPreview.appendChild(captureBtn);
                
                document.getElementById('closeCameraBtn').style.display = 'inline-block';
                
                showAlert('Camera opened! Click "Capture Photo" when ready.', 'success');
            } catch (error) {
                console.error('Camera error:', error);
                showAlert('Unable to access camera. Please ensure camera permissions are granted.', 'error');
            }
        }

        function capturePhotoFromCamera() {
            const videoElement = document.querySelector('#photoPreview video');
            if (!videoElement) {
                showAlert('No camera active.', 'error');
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            currentPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Display captured photo
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = `<img src="${currentPhotoData}" alt="Captured Photo">`;
            
            closeCamera();
            showAlert('Photo captured successfully!', 'success');
        }

        function closeCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            document.getElementById('closeCameraBtn').style.display = 'none';
            
            if (!currentPhotoData) {
                document.getElementById('photoPreview').innerHTML = '<span>Click "Open Camera" to capture photo</span>';
            }
        }

        // ==========================================
        // DATABASE MANAGEMENT
        // ==========================================
        
        function showAddToDatabase() {
            document.getElementById('addDatabaseForm').style.display = 'block';
            document.getElementById('addDatabaseForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelAddDatabase() {
            document.getElementById('addDatabaseForm').style.display = 'none';
            clearDatabaseForm();
        }

        function clearDatabaseForm() {
            document.getElementById('dbAgencyName').value = '';
            document.getElementById('dbPersonnelName').value = '';
            document.getElementById('dbDesignation').value = '';
        }

        async function addToDatabase() {
            const agencyName = document.getElementById('dbAgencyName').value.trim();
            const personnelName = document.getElementById('dbPersonnelName').value.trim();
            const designation = document.getElementById('dbDesignation').value;

            if (!agencyName || !personnelName || !designation) {
                showAlert('Please fill in all fields to add to database.', 'error');
                return;
            }

            const dbEntry = {
                action: 'addToDatabase',
                timestamp: new Date().toISOString(),
                agencyName: agencyName,
                personnelName: personnelName,
                designation: designation
            };

            try {
                showAlert('Adding to database...', 'info');
                
                await sendToGoogleSheets(dbEntry);
                
                // Add to local cache
                if (!agencyDatabase.includes(agencyName)) {
                    agencyDatabase.push(agencyName);
                }
                
                personnelDatabase.push({
                    agency: agencyName,
                    name: personnelName,
                    designation: designation
                });

                showAlert('Successfully added to database!', 'success');
                clearDatabaseForm();
                cancelAddDatabase();
                
                // Refresh dropdowns
                loadAgencies();
                
            } catch (error) {
                console.error('Error adding to database:', error);
                showAlert('Error adding to database. Please try again.', 'error');
            }
        }

        async function loadDatabaseFromSheets() {
            try {
                // This will be handled by the Google Apps Script
                // For now, we'll use local storage as fallback
                const response = await fetch(GOOGLE_SHEET_URL + '?action=getDatabase');
                const data = await response.json();
                
                if (data.agencies) {
                    agencyDatabase = data.agencies;
                }
                if (data.personnel) {
                    personnelDatabase = data.personnel;
                }
                
                loadAgencies();
            } catch (error) {
                console.log('Using local data');
                // Load from localStorage as fallback
                const storedAgencies = localStorage.getItem('agencyDatabase');
                const storedPersonnel = localStorage.getItem('personnelDatabase');
                
                if (storedAgencies) agencyDatabase = JSON.parse(storedAgencies);
                if (storedPersonnel) personnelDatabase = JSON.parse(storedPersonnel);
                
                loadAgencies();
            }
        }

        function loadAgencies() {
            const agencySelect = document.getElementById('agencyName');
            agencySelect.innerHTML = '<option value="">Select Agency</option>';
            
            const uniqueAgencies = [...new Set(agencyDatabase)];
            uniqueAgencies.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency;
                option.textContent = agency;
                agencySelect.appendChild(option);
            });
            
            // Save to localStorage
            localStorage.setItem('agencyDatabase', JSON.stringify(agencyDatabase));
            localStorage.setItem('personnelDatabase', JSON.stringify(personnelDatabase));
        }

        function loadPersonnelByAgency() {
            const selectedAgency = document.getElementById('agencyName').value;
            const personnelSelect = document.getElementById('guardName');
            
            personnelSelect.innerHTML = '<option value="">Select Personnel</option>';
            
            if (!selectedAgency) {
                personnelSelect.innerHTML = '<option value="">First select an agency</option>';
                document.getElementById('designation').value = '';
                return;
            }
            
            const filteredPersonnel = personnelDatabase.filter(p => p.agency === selectedAgency);
            
            if (filteredPersonnel.length === 0) {
                personnelSelect.innerHTML = '<option value="">No personnel found for this agency</option>';
            } else {
                filteredPersonnel.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.name;
                    option.setAttribute('data-designation', person.designation);
                    option.textContent = person.name;
                    personnelSelect.appendChild(option);
                });
            }
            
            document.getElementById('designation').value = '';
        }

        function autoFillDesignation() {
            const personnelSelect = document.getElementById('guardName');
            const selectedOption = personnelSelect.options[personnelSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const designation = selectedOption.getAttribute('data-designation');
                document.getElementById('designation').value = designation || '';
            } else {
                document.getElementById('designation').value = '';
            }
        }

        // ==========================================
        // ATTENDANCE MANAGEMENT
        // ==========================================
        
        function addGuard() {
            const agencyName = document.getElementById('agencyName').value;
            const guardName = document.getElementById('guardName').value;
            const designation = document.getElementById('designation').value;
            const postLocation = document.getElementById('postLocation').value;

            if (!agencyName) {
                showAlert('Please select a security agency.', 'error');
                return;
            }

            if (!guardName || !designation || !postLocation) {
                showAlert('Please fill in all personnel details.', 'error');
                return;
            }

            if (!currentPhotoData) {
                showAlert('Please capture a photo using the camera.', 'error');
                return;
            }

            // Check if guard already marked attendance
            const alreadyMarked = guards.find(g => g.name === guardName);
            if (alreadyMarked) {
                showAlert('This personnel has already been marked present.', 'error');
                return;
            }

            const guard = {
                id: Date.now(),
                agency: agencyName,
                name: guardName,
                designation: designation,
                location: postLocation,
                photo: currentPhotoData,
                checkInTime: new Date().toLocaleTimeString(),
                checkInDateTime: new Date().toISOString()
            };

            guards.push(guard);
            displayGuards();
            clearGuardForm();
            updateSummary();
            showAlert('Attendance marked successfully!', 'success');
        }

        function displayGuards() {
            const guardsList = document.getElementById('guardsList');
            
            if (guards.length === 0) {
                guardsList.innerHTML = '';
                return;
            }

            guardsList.innerHTML = '<h3 style="margin-bottom: 15px; color: #1e3c72;">ðŸ“‹ Attendance Marked</h3>';
            
            guards.forEach(guard => {
                const guardItem = document.createElement('div');
                guardItem.className = 'guard-item';
                guardItem.innerHTML = `
                    <div class="guard-header">
                        <strong>${guard.name}</strong>
                        <button class="btn btn-danger" onclick="removeGuard(${guard.id})">Remove</button>
                    </div>
                    <div class="guard-info">
                        <div><strong>Agency:</strong> ${guard.agency}</div>
                        <div><strong>Designation:</strong> ${guard.designation}</div>
                        <div><strong>Location:</strong> ${guard.location}</div>
                        <div><strong>Check-in:</strong> ${guard.checkInTime}</div>
                    </div>
                `;
                guardsList.appendChild(guardItem);
            });
        }

        function removeGuard(id) {
            if (confirm('Are you sure you want to remove this attendance record?')) {
                guards = guards.filter(g => g.id !== id);
                displayGuards();
                updateSummary();
                showAlert('Attendance record removed.', 'success');
            }
        }

        function clearGuardForm() {
            document.getElementById('guardName').value = '';
            document.getElementById('designation').value = '';
            document.getElementById('postLocation').value = '';
            document.getElementById('photoPreview').innerHTML = '<span>Click "Open Camera" to capture photo</span>';
            currentPhotoData = null;
            closeCamera();
        }

        function updateSummary() {
            document.getElementById('totalGuards').textContent = guards.length;
        }

        // ==========================================
        // ALERT SYSTEM
        // ==========================================
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.textContent = message;
            alertBox.classList.remove('hidden');
            
            setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 5000);
        }

        // ==========================================
        // SUBMIT ATTENDANCE
        // ==========================================
        
        async function submitAttendance() {
            const agencyName = document.getElementById('agencyName').value;
            const shiftTiming = document.getElementById('shiftTiming').value;

            if (!agencyName || !shiftTiming) {
                showAlert('Please select Agency and Shift Timing.', 'error');
                return;
            }

            if (guards.length === 0) {
                showAlert('Please mark attendance for at least one personnel.', 'error');
                return;
            }

            if (!confirm(`Submit attendance for ${guards.length} personnel?`)) {
                return;
            }

            showAlert('Submitting attendance to Google Sheets...', 'info');

            const attendanceData = {
                action: 'submitAttendance',
                date: new Date().toLocaleDateString('en-IN'),
                time: new Date().toLocaleTimeString('en-IN'),
                agency: agencyName,
                shift: shiftTiming,
                totalGuards: guards.length,
                guards: guards.map(g => ({
                    name: g.name,
                    designation: g.designation,
                    location: g.location,
                    checkInTime: g.checkInTime,
                    checkInDateTime: g.checkInDateTime
                }))
            };

            try {
                await sendToGoogleSheets(attendanceData);
                showAlert('Attendance submitted successfully to Google Sheets!', 'success');
                
                setTimeout(() => {
                    generatePDF(attendanceData);
                }, 1000);
            } catch (error) {
                console.error('Error:', error);
                showAlert('Attendance saved locally. Generating PDF...', 'error');
                generatePDF(attendanceData);
            }
        }

        // ==========================================
        // GOOGLE SHEETS INTEGRATION
        // ==========================================
        
        async function sendToGoogleSheets(data) {
            if (GOOGLE_SHEET_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                console.warn('Google Sheets URL not configured');
                throw new Error('Please configure Google Sheets Web App URL');
            }

            const response = await fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            return response;
        }

        // ==========================================
        // PDF GENERATION
        // ==========================================
        
        function generatePDF(data) {
            document.getElementById('reportDateTime').textContent = 
                `Date: ${data.date} | Time: ${data.time}`;
            document.getElementById('reportAgency').textContent = 
                `Security Agency: ${data.agency}`;
            document.getElementById('reportShift').textContent = 
                `Shift: ${data.shift}`;
            document.getElementById('reportTotal').textContent = data.totalGuards;

            const tableBody = document.getElementById('reportTableBody');
            tableBody.innerHTML = '';

            data.guards.forEach((guard, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${guard.name}</td>
                    <td>${guard.designation}</td>
                    <td>${guard.location}</td>
                    <td>${guard.checkInTime}</td>
                `;
                tableBody.appendChild(row);
            });

            const { jsPDF } = window.jspdf;
            const element = document.getElementById('pdfReport');
            
            html2canvas(element, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                const fileName = `Security_Attendance_${data.date.replace(/\//g, '-')}_${data.shift.replace(/\s/g, '_')}.pdf`;
                pdf.save(fileName);

                showAlert('PDF generated! You can now share it on WhatsApp.', 'success');
                
                if (confirm('Attendance submitted and PDF generated. Reset form for new entry?')) {
                    resetForm();
                }
            });
        }

        // ==========================================
        // FORM RESET
        // ==========================================
        
        function resetForm() {
            guards = [];
            document.getElementById('agencyName').value = '';
            document.getElementById('shiftTiming').value = '';
            clearGuardForm();
            displayGuards();
            updateSummary();
            document.getElementById('summaryShift').textContent = 'Not selected';
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        window.addEventListener('load', function() {
            loadDatabaseFromSheets();
        });

        // Clean up camera on page unload
        window.addEventListener('beforeunload', function() {
            closeCamera();
        });
    </script>
</body>
</html>
